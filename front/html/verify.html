<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalletConnect Wallet Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/client@1.6.6/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
</head>
<body>
    <h1>Wallet Verification via WalletConnect</h1>
    <button id="verifyWalletButton">Verify Wallet Ownership</button>
    <div id="qrcode"></div>

    <script>
        const walletAddress = "0xb39d9C554EfDea3382D833c7F2E2dc555D08aB82"; // Replace with the user's wallet address

        async function verifyWalletOwnership() {
            // Initialize WalletConnect
            const walletConnector = new WalletConnect.default({
                bridge: 'https://bridge.walletconnect.org' // You can use any WalletConnect bridge
            });

            // Check if WalletConnect session already exists
            if (!walletConnector.connected) {
                // Create a new session
                walletConnector.createSession();
            }

            // Listen for WalletConnect URI to show QR code or deep link
            walletConnector.on("display_uri", (uri) => {
                console.log("Scan this QR code with your mobile wallet:", uri);
                // Generate QR code and display it on the screen
                const qrCodeContainer = document.getElementById("qrcode");
                qrCodeContainer.innerHTML = ""; // Clear previous QR code if any
                QRCode.toCanvas(qrCodeContainer, uri, function (error) {
                    if (error) console.error(error);
                    console.log('QR code generated!');
                });
            });

            // When a session is connected
            walletConnector.on("connect", async (error, payload) => {
                if (error) {
                    throw error;
                }

                // Get the user's wallet account
                const { accounts } = payload.params[0];
                const account = accounts[0];

                // Fetch challenge from backend
                const response = await fetch(`https://iktomi.pro/generate_challenge/${walletAddress}`);
                const data = await response.json();
                const challenge = data.challenge;

                // Request the user to sign the challenge using WalletConnect
                const msgParams = {
                    type: 'personal_sign',
                    params: [challenge, account],
                    from: account
                };

                try {
                    const signature = await walletConnector.sendCustomRequest(msgParams);

                    // Send the signature and wallet address to the backend for verification
                    const verificationResponse = await fetch('https://iktomi.pro/api/web3/verify_signature', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            wallet_address: walletAddress,
                            signature: signature
                        })
                    });

                    const verificationResult = await verificationResponse.json();

                    if (verificationResponse.ok) {
                        alert(verificationResult.message);
                    } else {
                        alert('Verification failed: ' + verificationResult.detail);
                    }
                } catch (err) {
                    console.error(err);
                    alert('An error occurred during verification.');
                }
            });

            // Disconnect listener
            walletConnector.on("disconnect", (error, payload) => {
                if (error) {
                    throw error;
                }
                alert('Disconnected from WalletConnect');
            });
        }

        document.getElementById('verifyWalletButton').addEventListener('click', verifyWalletOwnership);
    </script>
</body>
</html>